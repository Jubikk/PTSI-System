<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratory Result</title>
    <link rel="stylesheet" href="../assets/css/labresult-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="https://philtbsociety.org/wp-content/uploads/2022/07/cropped-1-PTSI-New-Logo-Original-1-600x786.png" alt="PTSI Logo" class="logo">
            <h2>PTSI</h2>
            <div class="sidebar-toggle" id="toggleSidebar">
                <img src="../assets/img/arrow-left.png" alt="Hide Sidebar">
            </div>
        </div>
        <ul class="menu">
        <h3>Menu</h3>
        <li id="dashboard"><i class="icon"><img src="../assets/img/dash-icon.png"></i><h3>Dashboard</h3></li>
        <li id="lab-result"><i class="icon"><img src="../assets/img/lab-result-icon.png"></i><h3>Lab Result</h3></li>
        <li id="appointment"><i class="icon"><img src="../assets/img/appointment-icon.png"></i><h3>Appointment</h3></li>
        </ul>
        <div class="logout" id="logout">
            <img src="../assets/img/logout-icon.png" alt="Logout Icon">
            <h3>Logout</h3>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="header-left">
              <div class="hamburger" id="hamburger">
                <img src="../assets/img/hamburger-icon.png" alt="Menu"/>
              </div>
              <div class="labresult-title"><strong>Dashboard</strong></div>
            </div>
        <div class="header-icons">
            <span><img src="../assets/img/notif-icon.png"></span>
            <span><img src="../assets/img/profile-icon.png"></span>
        </div>
    </div>
    
    <div class="container">
        <!-- Header Section -->
        <h1 class="header-title">
            Shin Ryujin
        </h1>

        <!-- Table Section -->
        <div class="table-wrapper">
            <table>
                <thead class="table-header">
                    <tr>
                        <th class="table-header-cell">
                            Document
                        </th>
                        <th class="table-header-cell">
                            Date
                        </th>
                        <th class="table-header-cell">
                            Type
                        </th>
                        <th class="table-header-cell">
                            File
                        </th>
                    </tr>
                </thead>
                <tbody id="labResultsBody">
                </tbody>
            </table>
        </div>
    </div>

    <script src="../assets/js/menu.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      
        const firebaseConfig = {
          apiKey: "AIzaSyDA_dVWeUjfgWTJHTIkIomj6ALtD_Lre6g",
          authDomain: "ptsi-project-48025.firebaseapp.com",
          projectId: "ptsi-project-48025",
          storageBucket: "ptsi-project-48025.appspot.com",
          messagingSenderId: "761002258561",
          appId: "1:761002258561:web:1fce70be6b73c1b628dd80"
        };
      
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
      
        const code = sessionStorage.getItem("labResultCode");
      
        if (!code || !/^\d{6}$/.test(code)) {
          alert("⚠️ Invalid or missing code. Redirecting...");
          window.location.href = "labresult-login.html";
        } else {
          try {
            const labResultsRef = collection(db, "labResults");
            const q = query(labResultsRef, where("resultCode", "==", code));
            getDocs(q).then((snapshot) => {
              if (snapshot.empty) {
                alert("❌ No result found for this code.");
                return;
              }
      
              const labResultsBody = document.getElementById("labResultsBody");
      
              snapshot.forEach((docSnap) => {
                const data = docSnap.data();
      
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td class="table-data-cell">#${data.laboratoryId}</td>
                  <td class="table-data-cell">${data.date}</td>
                  <td class="table-data-cell">${data.resultType}</td>
                  <td class="table-data-cell">
                    <a href="${data.pdfBase64}" class="download-link" target="_blank">
                      View PDF <i class="fas fa-download download-icon"></i>
                    </a>
                  </td>
                `;
                labResultsBody.appendChild(row);
      
                // Optional: update patient name at top
                document.querySelector(".header-title").textContent = data.patientName;
              });
            });
          } catch (error) {
            console.error("Error loading lab result:", error);
            alert("❌ Error loading lab result. Please try again.");
          }
        }
      </script>
</body>
</html>